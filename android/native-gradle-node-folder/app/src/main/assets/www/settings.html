<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Settings â€“ Note Secretary</title>
<link rel="stylesheet" href="common.css">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
  <header>
    <button id="menuBtn">â˜°</button>
    <div class="spacer"></div>
    <div class="connection-status">
      <span class="connection-led" id="statusLed"></span>
      <span id="statusText">Connecting...</span>
    </div>
    <select id="lang">
      <option value="en-US">English</option>
      <option value="he-IL">×¢×‘×¨×™×ª</option>
    </select>
    <button id="clearBtn" class="secondary" title="Clear chat messages">ğŸ—‘ï¸</button>
  </header>

  <div class="settings-container">
    <h2>Settings</h2>

    <div class="settings-section">
      <h3>Gemini API Configuration</h3>
      <label for="geminiApiKey">Gemini API Key:</label>
      <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key">
      <button id="saveApiKey">Save API Key</button>
      <button id="useDefaultKey" class="secondary">Use Default Key</button>
      <div style="margin-top:10px;">
        <strong>Current Status:</strong> <span id="apiStatus">Using default API key</span>
      </div>
    </div>

    <div class="settings-section">
      <h3>Workflow Settings</h3>
      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <button id="toggleAutoConfirmBtn" class="nav-button" style="background:#2d5a87; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:14px; width:auto;">
          Auto Confirm: OFF
        </button>
        <small style="color:#666; font-size:12px;">Toggle auto confirmation for all actions</small>
      </div>
      <div style="font-size:12px; color:#a0a0a0;">
        When enabled, the system will automatically proceed with "Yes" for all confirmation prompts (note creation, deletion, marking as done, etc.)
      </div>
    </div>

    <div class="settings-section">
      <h3>Chat History</h3>
      <div style="display:flex; align-items:center; gap:16px;">
        <button id="clearChatHistory" class="secondary" style="background:#ff6b35;">ğŸ—‘ï¸ Clear Chat History</button>
        <small style="color:#a0a0a0; font-size:12px;">Clear all chat messages and history</small>
      </div>
    </div>

    <div class="settings-section">
      <h3>AI Action Statistics</h3>
      <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:16px;">
        <div style="display:flex; align-items:center; gap:16px; padding:12px; background:#1a1a1a; border-radius:6px;">
          <div style="display:flex; flex-direction:column; align-items:center; min-width:80px;">
            <div style="font-size:24px; font-weight:bold; color:#4CAF50;" id="successCounter">0</div>
            <div style="font-size:12px; color:#888;">Success</div>
          </div>
          <div style="flex:1;">
            <div style="font-size:14px; font-weight:bold; color:#fff;">AI Actions Success Rate</div>
            <div style="font-size:12px; color:#aaa;">Successful AI suggestions that user confirmed</div>
          </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:16px; padding:12px; background:#1a1a1a; border-radius:6px;">
          <div style="display:flex; flex-direction:column; align-items:center; min-width:80px;">
            <div style="font-size:24px; font-weight:bold; color:#ff6b35;" id="failureCounter">0</div>
            <div style="font-size:12px; color:#888;">Failed</div>
          </div>
          <div style="flex:1;">
            <div style="font-size:14px; font-weight:bold; color:#fff;">AI Actions Failure Rate</div>
            <div style="font-size:12px; color:#aaa;">AI suggestions that didn't satisfy user requests</div>
          </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:16px; padding:12px; background:#2a2f36; border-radius:6px;">
          <div style="display:flex; flex-direction:column; align-items:center; min-width:80px;">
            <div style="font-size:20px; font-weight:bold; color:#4CAF50;" id="successRate">0%</div>
            <div style="font-size:12px; color:#888;">Rate</div>
          </div>
          <div style="flex:1;">
            <div style="font-size:14px; font-weight:bold; color:#fff;">Overall Success Rate</div>
            <div style="font-size:12px; color:#aaa;">Success / (Success + Failed)</div>
          </div>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="resetCounters" class="secondary" style="background:#ff6b35;">ğŸ”„ Reset Counters</button>
        <button id="refreshStats" class="secondary" style="background:#4CAF50;">ğŸ”„ Refresh Stats</button>
        <button id="downloadLogs" class="secondary" style="background:#2d5a87;">ğŸ“¥ Download Logs</button>
        <button id="viewLogs" class="secondary" style="background:#9C27B0;">ğŸ‘ï¸ View Logs</button>
      </div>
    </div>

    <div class="settings-section">
      <h3>Debug Tools</h3>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="showNotes">Show Notes (Debug)</button>
        <button id="clearNotes" class="secondary" style="background:#ff4444;">ğŸ—‘ï¸ Clear All Notes (DANGER)</button>
      </div>
      <div id="notesDisplay" style="margin-top:10px; padding:10px; background:#2a2f36; border-radius:6px; max-height:200px; overflow-y:auto; font-family:monospace; font-size:12px; white-space:pre-wrap; display:none;"></div>
    </div>

    <div class="settings-section" id="logDisplaySection" style="display:none;">
      <h3>Application Logs</h3>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button id="copyLogs" class="secondary" style="background:#4CAF50;">ğŸ“‹ Copy Logs</button>
        <button id="clearLogs" class="secondary" style="background:#ff6b35;">ğŸ—‘ï¸ Clear Logs</button>
        <button id="closeLogs" class="secondary" style="background:#666;">âœ• Close</button>
      </div>
      <div id="logDisplay" style="padding:10px; background:#1a1a1a; border-radius:6px; max-height:400px; overflow-y:auto; font-family:monospace; font-size:11px; white-space:pre-wrap; color:#fff; border:1px solid #333;"></div>
    </div>
  </div>

</div>

<!-- Side Menu -->
<div class="overlay" id="overlay"></div>
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <h2>Menu</h2>
    <button id="closeMenu">âœ•</button>
  </div>
  <div class="side-menu-content">
    <h3>Navigation</h3>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">
      <button id="chatButton" class="nav-button secondary">ğŸ’¬ Chat</button>
      <button id="explorerButton" class="nav-button secondary">ğŸ“ Note Explorer</button>
      <button id="settingsButton" class="nav-button active">âš™ï¸ Settings</button>
    </div>
  </div>
</div>

<!-- Load shared WebSocket client -->
<script src="shared-websocket.js"></script>

<script>
/* ---------- Settings ---------- */
const Settings = { 
  lang: "en",
  geminiApiKey: "AIzaSyC9dXJT4ol3i2VoK6aqLjX5S7IMKSjwNC4", // Default API key
  autoConfirm: false
};

// Global variables
var GlobalAutoConfirm = {
  enabled: false,
  toggle: function() {
    this.enabled = !this.enabled;
    Settings.autoConfirm = this.enabled;
    this.updateUI();
    this.saveToStorage();
    this.updateBackend();
    return this.enabled;
  },
  updateUI: function() {
    const btn = document.getElementById('toggleAutoConfirmBtn');
    if (btn) {
      btn.textContent = `Auto Confirm: ${this.enabled ? 'ON' : 'OFF'}`;
      btn.style.background = this.enabled ? '#28a745' : '#2d5a87';
    }
  },
  saveToStorage: function() {
    localStorage.setItem('globalAutoConfirm', this.enabled.toString());
  },
  loadFromStorage: function() {
    const saved = localStorage.getItem('globalAutoConfirm');
    this.enabled = saved === 'true';
    Settings.autoConfirm = this.enabled;
    this.updateUI();
  },
  updateBackend: function() {
    sendToWorker({ type: 'set_auto_confirm', enabled: this.enabled });
    Settings.autoConfirm = this.enabled;
  }
};

/* ---------- UI wiring ---------- */
const langSel = document.getElementById("lang");
const clearBtn= document.getElementById("clearBtn");
const menuBtn = document.getElementById("menuBtn");
const sideMenu = document.getElementById("sideMenu");
const overlay = document.getElementById("overlay");
const closeMenu = document.getElementById("closeMenu");
const geminiApiKey = document.getElementById("geminiApiKey");
const saveApiKey = document.getElementById("saveApiKey");
const useDefaultKey = document.getElementById("useDefaultKey");
const apiStatus = document.getElementById("apiStatus");
const showNotes = document.getElementById("showNotes");
const notesDisplay = document.getElementById("notesDisplay");
const clearNotes = document.getElementById("clearNotes");
const clearChatHistoryBtn = document.getElementById("clearChatHistory");
const chatButton = document.getElementById("chatButton");
const explorerButton = document.getElementById("explorerButton");
const settingsButton = document.getElementById("settingsButton");
const successCounter = document.getElementById("successCounter");
const failureCounter = document.getElementById("failureCounter");
const successRate = document.getElementById("successRate");
const resetCounters = document.getElementById("resetCounters");
const refreshStats = document.getElementById("refreshStats");
const downloadLogs = document.getElementById("downloadLogs");
const viewLogs = document.getElementById("viewLogs");
const logDisplaySection = document.getElementById("logDisplaySection");
const logDisplay = document.getElementById("logDisplay");
const copyLogs = document.getElementById("copyLogs");
const clearLogs = document.getElementById("clearLogs");
const closeLogs = document.getElementById("closeLogs");

langSel.onchange = () => {
  Settings.lang = langSel.value;
  document.documentElement.dir = (Settings.lang === "he") ? "rtl" : "ltr";
};
clearBtn.onclick = () => { 
  if (confirm("Are you sure you want to clear all chat messages?")) {
    clearChatHistory();
    addMsg("ğŸ—‘ï¸ Chat messages cleared", "sys");
  }
};

menuBtn.onclick = () => {
  sideMenu.classList.add("open");
  overlay.classList.add("show");
};

closeMenu.onclick = () => {
  sideMenu.classList.remove("open");
  overlay.classList.remove("show");
};

overlay.onclick = () => {
  sideMenu.classList.remove("open");
  overlay.classList.remove("show");
};

function navigateToPage(page) {
  window.location.href = page;
}

chatButton.onclick = () => navigateToPage('index.html');
explorerButton.onclick = () => navigateToPage('explorer.html');
settingsButton.onclick = () => navigateToPage('settings.html');

const toggleAutoConfirmBtn = document.getElementById('toggleAutoConfirmBtn');
if (toggleAutoConfirmBtn) {
  toggleAutoConfirmBtn.onclick = () => GlobalAutoConfirm.toggle();
}

function loadStoredApiKey() {
  const storedKey = localStorage.getItem('geminiApiKey');
  if (storedKey) {
    geminiApiKey.value = storedKey;
    Settings.geminiApiKey = storedKey;
    apiStatus.textContent = "Using custom API key";
    apiStatus.style.color = "#4CAF50";
  } else {
    apiStatus.textContent = "Using default API key";
    apiStatus.style.color = "#FFA500";
  }
  GlobalAutoConfirm.loadFromStorage();
  Settings.autoConfirm = GlobalAutoConfirm.enabled;
}

saveApiKey.onclick = () => {
  const key = geminiApiKey.value.trim();
  if (key) {
    localStorage.setItem('geminiApiKey', key);
    Settings.geminiApiKey = key;
    apiStatus.textContent = "Custom API key saved";
    apiStatus.style.color = "#4CAF50";
    sendToWorker({ type: 'save_settings', geminiApiKey: key });
  }
};

useDefaultKey.onclick = () => {
  localStorage.removeItem('geminiApiKey');
  Settings.geminiApiKey = "AIzaSyC9dXJT4ol3i2VoK6aqLjX5S7IMKSjwNC4";
  geminiApiKey.value = "";
  apiStatus.textContent = "Using default API key";
  apiStatus.style.color = "#FFA500";
  sendToWorker({ type: 'save_settings', geminiApiKey: Settings.geminiApiKey });
};

showNotes.onclick = () => {
  if (notesDisplay.style.display === "none") {
    sendToWorker({type:'debug', action:'get_notes'});
    showNotes.textContent = "Hide Notes";
  } else {
    showNotes.textContent = "Show Notes (Debug)";
    notesDisplay.style.display = "none";
  }
};

clearNotes.onclick = () => {
  if (confirm("DANGER: This will permanently delete all notes. Are you sure?")) {
    sendToWorker({type:'debug', action:'clear_notes'});
  }
};

clearChatHistoryBtn.onclick = () => {
  if (confirm("Are you sure you want to clear the chat history?")) {
    clearChatHistory();
  }
};

// AI Action Statistics Management
const AIStats = {
  success: 0,
  failure: 0,
  
  incrementSuccess: function() {
    this.success++;
    this.saveToStorage();
    this.updateUI();
    logger.info(`AI Action Success: ${this.success}`);
  },
  
  incrementFailure: function() {
    this.failure++;
    this.saveToStorage();
    this.updateUI();
    logger.info(`AI Action Failure: ${this.failure}`);
  },
  
  updateUI: function() {
    if (successCounter) successCounter.textContent = this.success;
    if (failureCounter) failureCounter.textContent = this.failure;
    
    const total = this.success + this.failure;
    const rate = total > 0 ? Math.round((this.success / total) * 100) : 0;
    if (successRate) successRate.textContent = `${rate}%`;
  },
  
  saveToStorage: function() {
    localStorage.setItem('aiStats', JSON.stringify({
      success: this.success,
      failure: this.failure
    }));
  },
  
  loadFromStorage: function() {
    const saved = localStorage.getItem('aiStats');
    if (saved) {
      const data = JSON.parse(saved);
      this.success = data.success || 0;
      this.failure = data.failure || 0;
    }
    this.updateUI();
  },
  
  reset: function() {
    this.success = 0;
    this.failure = 0;
    this.saveToStorage();
    this.updateUI();
    // Send reset command to backend
    sendToWorker({ type: 'reset_ai_stats' });
  }
};

resetCounters.onclick = () => {
  if (confirm("Are you sure you want to reset the AI action counters?")) {
    AIStats.reset();
  }
};

downloadLogs.onclick = () => {
  // Download logs from the server with mobile compatibility
  const timestamp = new Date().toISOString().split('T')[0];
  const filename = `app-logs-${timestamp}.txt`;
  
  // Check if we're in a mobile app environment
  const isMobile = navigator.userAgent.includes('Mobile') || 
                   navigator.userAgent.includes('Android') || 
                   navigator.userAgent.includes('iPhone') ||
                   window.navigator.standalone === true;
  
  if (isMobile) {
    // For mobile apps, use direct URL navigation which should trigger WebView download
    const downloadUrl = `http://localhost:30000/logs/download`;
    window.open(downloadUrl, '_blank');
    
    // Show user feedback
    setTimeout(() => {
      alert('Log file download initiated. Check your Downloads folder or browser downloads.');
    }, 500);
  } else {
    // For desktop browsers, use blob download
    fetch('http://localhost:30000/logs/download')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      })
      .catch(error => {
        console.error('Error downloading logs:', error);
        alert('Error downloading logs: ' + error.message);
      });
  }
};

refreshStats.onclick = () => {
  // Fetch stats from server
  fetch('http://localhost:30000/ai/stats')
    .then(response => response.json())
    .then(data => {
      console.log('[AI_STATS] Fetched stats from server:', data);
      AIStats.success = data.success || 0;
      AIStats.failure = data.failure || 0;
      AIStats.updateUI();
    })
    .catch(error => {
      console.error('[AI_STATS] Error fetching stats:', error);
    });
};

viewLogs.onclick = () => {
  // Fetch and display logs
  fetch('http://localhost:30000/logs/download')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();
    })
    .then(logText => {
      logDisplay.textContent = logText;
      logDisplaySection.style.display = 'block';
      // Scroll to top
      logDisplay.scrollTop = 0;
    })
    .catch(error => {
      console.error('Error fetching logs:', error);
      logDisplay.textContent = 'Error fetching logs: ' + error.message;
      logDisplaySection.style.display = 'block';
    });
};

copyLogs.onclick = () => {
  // Copy logs to clipboard
  const logText = logDisplay.textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(logText).then(() => {
      alert('Logs copied to clipboard!');
    }).catch(err => {
      console.error('Failed to copy logs:', err);
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = logText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('Logs copied to clipboard!');
    });
  } else {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = logText;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Logs copied to clipboard!');
  }
};

clearLogs.onclick = () => {
  if (confirm('Are you sure you want to clear all application logs?')) {
    fetch('http://localhost:30000/logs/clear', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Logs cleared successfully!');
          logDisplay.textContent = 'Logs cleared.';
        } else {
          alert('Failed to clear logs.');
        }
      })
      .catch(error => {
        console.error('Error clearing logs:', error);
        alert('Error clearing logs: ' + error.message);
      });
  }
};

closeLogs.onclick = () => {
  logDisplaySection.style.display = 'none';
};

function sendToWorker(messageObject) {
    SharedWebSocket.send(messageObject);
}

function initializeWebSocket() {
    // Use shared WebSocket instead of direct service worker communication
    SharedWebSocket.registerHandler('ws_connecting', () => {
        updateConnectionStatus('CONNECTING');
    });
    SharedWebSocket.registerHandler('ws_open', () => {
        updateConnectionStatus('OPEN');
    });
    
    SharedWebSocket.registerHandler('ws_close', () => {
        updateConnectionStatus('CLOSED');
    });
    
    SharedWebSocket.registerHandler('ws_error', () => {
        updateConnectionStatus('CLOSED');
    });
    
    SharedWebSocket.registerHandler('debug_notes', (data) => {
        const notesDisplay = document.getElementById("notesDisplay");
        if (notesDisplay) {
            notesDisplay.textContent = data.notes;
            notesDisplay.style.display = "block";
        }
    });
    
    SharedWebSocket.registerHandler('debug_cleared', (data) => {
        const notesDisplay = document.getElementById("notesDisplay");
        const showNotes = document.getElementById("showNotes");
        if (notesDisplay) notesDisplay.style.display = "none";
        if (showNotes) showNotes.textContent = "Show Notes (Debug)";
    });
    
    SharedWebSocket.registerHandler('auto_confirm_status', (data) => {
        GlobalAutoConfirm.enabled = data.enabled;
        Settings.autoConfirm = data.enabled;
        GlobalAutoConfirm.updateUI();
    });
    
    // AI Action Statistics handlers
    SharedWebSocket.registerHandler('ai_action_success', (data) => {
        console.log('[AI_STATS] Received ai_action_success:', data);
        AIStats.incrementSuccess();
    });
    
    SharedWebSocket.registerHandler('ai_action_failure', (data) => {
        console.log('[AI_STATS] Received ai_action_failure:', data);
        AIStats.incrementFailure();
    });
    
    SharedWebSocket.registerHandler('ai_stats_update', (data) => {
        console.log('[AI_STATS] Received ai_stats_update:', data);
        AIStats.success = data.success || 0;
        AIStats.failure = data.failure || 0;
        AIStats.updateUI();
    });
}

function updateConnectionStatus(state) {
  const statusLed = document.getElementById('statusLed');
  const statusText = document.getElementById('statusText');
  if (!statusLed || !statusText) return;
  switch (state) {
    case 'OPEN':
      statusLed.className = 'connection-led connected';
      statusText.textContent = 'Connected';
      break;
    case 'CONNECTING':
      statusLed.className = 'connection-led connecting';
      statusText.textContent = 'Connecting...';
      break;
    case 'CLOSED':
      statusLed.className = 'connection-led disconnected';
      statusText.textContent = 'Disconnected';
      break;
  }
}

function clearChatHistory() {
  localStorage.removeItem('chatHistory');
}

function initializeSettings() {
  const key = localStorage.getItem('geminiApiKey');
  if (key) Settings.geminiApiKey = key;
  loadStoredApiKey();
  AIStats.loadFromStorage();
  
  // Also fetch stats from server on page load
  fetch('http://localhost:30000/ai/stats')
    .then(response => response.json())
    .then(data => {
      console.log('[AI_STATS] Initial stats from server:', data);
      AIStats.success = data.success || 0;
      AIStats.failure = data.failure || 0;
      AIStats.updateUI();
    })
    .catch(error => {
      console.error('[AI_STATS] Error fetching initial stats:', error);
    });
}

/* ---------- Page Load ---------- */
initializeSettings();
initializeWebSocket();

</script>
</body>
</html>