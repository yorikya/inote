<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Settings – Note Secretary</title>
<link rel="stylesheet" href="common.css">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
  <header>
    <button id="menuBtn">☰</button>
    <div class="spacer"></div>
    <div class="connection-status">
      <span class="connection-led" id="statusLed"></span>
      <span id="statusText">Connecting...</span>
    </div>
    <select id="lang">
      <option value="en-US">English</option>
      <option value="he-IL">עברית</option>
    </select>
    <button id="clearBtn" class="secondary" title="Clear chat messages">🗑️</button>
  </header>

  <div class="settings-container">
    <h2>Settings</h2>

    <div class="settings-section">
      <h3>Gemini API Configuration</h3>
      <label for="geminiApiKey">Gemini API Key:</label>
      <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key">
      <button id="saveApiKey">Save API Key</button>
      <button id="useDefaultKey" class="secondary">Use Default Key</button>
      <div style="margin-top:10px;">
        <strong>Current Status:</strong> <span id="apiStatus">Using default API key</span>
      </div>
    </div>

    <div class="settings-section">
      <h3>Workflow Settings</h3>
      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <button id="toggleAutoConfirmBtn" class="nav-button" style="background:#2d5a87; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:14px; width:auto;">
          Auto Confirm: OFF
        </button>
        <small style="color:#666; font-size:12px;">Toggle auto confirmation for all actions</small>
      </div>
      <div style="font-size:12px; color:#a0a0a0;">
        When enabled, the system will automatically proceed with "Yes" for all confirmation prompts (note creation, deletion, marking as done, etc.)
      </div>
    </div>

    <div class="settings-section">
      <h3>Chat History</h3>
      <div style="display:flex; align-items:center; gap:16px;">
        <button id="clearChatHistory" class="secondary" style="background:#ff6b35;">🗑️ Clear Chat History</button>
        <small style="color:#a0a0a0; font-size:12px;">Clear all chat messages and history</small>
      </div>
    </div>

    <div class="settings-section">
      <h3>Debug Tools</h3>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="showNotes">Show Notes (Debug)</button>
        <button id="clearNotes" class="secondary" style="background:#ff4444;">🗑️ Clear All Notes (DANGER)</button>
      </div>
      <div id="notesDisplay" style="margin-top:10px; padding:10px; background:#2a2f36; border-radius:6px; max-height:200px; overflow-y:auto; font-family:monospace; font-size:12px; white-space:pre-wrap; display:none;"></div>
    </div>
  </div>

</div>

<!-- Side Menu -->
<div class="overlay" id="overlay"></div>
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <h2>Menu</h2>
    <button id="closeMenu">✕</button>
  </div>
  <div class="side-menu-content">
    <h3>Navigation</h3>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">
      <button id="chatButton" class="nav-button secondary">💬 Chat</button>
      <button id="explorerButton" class="nav-button secondary">📝 Note Explorer</button>
      <button id="settingsButton" class="nav-button active">⚙️ Settings</button>
    </div>
  </div>
</div>

<!-- Load shared WebSocket client -->
<script src="shared-websocket.js"></script>

<script>
/* ---------- Settings ---------- */
const Settings = { 
  lang: "en",
  geminiApiKey: "AIzaSyC9dXJT4ol3i2VoK6aqLjX5S7IMKSjwNC4", // Default API key
  autoConfirm: false
};

// Global variables
var GlobalAutoConfirm = {
  enabled: false,
  toggle: function() {
    this.enabled = !this.enabled;
    Settings.autoConfirm = this.enabled;
    this.updateUI();
    this.saveToStorage();
    this.updateBackend();
    return this.enabled;
  },
  updateUI: function() {
    const btn = document.getElementById('toggleAutoConfirmBtn');
    if (btn) {
      btn.textContent = `Auto Confirm: ${this.enabled ? 'ON' : 'OFF'}`;
      btn.style.background = this.enabled ? '#28a745' : '#2d5a87';
    }
  },
  saveToStorage: function() {
    localStorage.setItem('globalAutoConfirm', this.enabled.toString());
  },
  loadFromStorage: function() {
    const saved = localStorage.getItem('globalAutoConfirm');
    this.enabled = saved === 'true';
    Settings.autoConfirm = this.enabled;
    this.updateUI();
  },
  updateBackend: function() {
    sendToWorker({ type: 'set_auto_confirm', enabled: this.enabled });
    Settings.autoConfirm = this.enabled;
  }
};

/* ---------- UI wiring ---------- */
const langSel = document.getElementById("lang");
const clearBtn= document.getElementById("clearBtn");
const menuBtn = document.getElementById("menuBtn");
const sideMenu = document.getElementById("sideMenu");
const overlay = document.getElementById("overlay");
const closeMenu = document.getElementById("closeMenu");
const geminiApiKey = document.getElementById("geminiApiKey");
const saveApiKey = document.getElementById("saveApiKey");
const useDefaultKey = document.getElementById("useDefaultKey");
const apiStatus = document.getElementById("apiStatus");
const showNotes = document.getElementById("showNotes");
const notesDisplay = document.getElementById("notesDisplay");
const clearNotes = document.getElementById("clearNotes");
const clearChatHistoryBtn = document.getElementById("clearChatHistory");
const chatButton = document.getElementById("chatButton");
const explorerButton = document.getElementById("explorerButton");
const settingsButton = document.getElementById("settingsButton");

langSel.onchange = () => {
  Settings.lang = langSel.value;
  document.documentElement.dir = (Settings.lang === "he") ? "rtl" : "ltr";
};
clearBtn.onclick = () => { 
  if (confirm("Are you sure you want to clear all chat messages?")) {
    clearChatHistory();
    addMsg("🗑️ Chat messages cleared", "sys");
  }
};

menuBtn.onclick = () => {
  sideMenu.classList.add("open");
  overlay.classList.add("show");
};

closeMenu.onclick = () => {
  sideMenu.classList.remove("open");
  overlay.classList.remove("show");
};

overlay.onclick = () => {
  sideMenu.classList.remove("open");
  overlay.classList.remove("show");
};

function navigateToPage(page) {
  window.location.href = page;
}

chatButton.onclick = () => navigateToPage('index.html');
explorerButton.onclick = () => navigateToPage('explorer.html');
settingsButton.onclick = () => navigateToPage('settings.html');

const toggleAutoConfirmBtn = document.getElementById('toggleAutoConfirmBtn');
if (toggleAutoConfirmBtn) {
  toggleAutoConfirmBtn.onclick = () => GlobalAutoConfirm.toggle();
}

function loadStoredApiKey() {
  const storedKey = localStorage.getItem('geminiApiKey');
  if (storedKey) {
    geminiApiKey.value = storedKey;
    Settings.geminiApiKey = storedKey;
    apiStatus.textContent = "Using custom API key";
    apiStatus.style.color = "#4CAF50";
  } else {
    apiStatus.textContent = "Using default API key";
    apiStatus.style.color = "#FFA500";
  }
  GlobalAutoConfirm.loadFromStorage();
  Settings.autoConfirm = GlobalAutoConfirm.enabled;
}

saveApiKey.onclick = () => {
  const key = geminiApiKey.value.trim();
  if (key) {
    localStorage.setItem('geminiApiKey', key);
    Settings.geminiApiKey = key;
    apiStatus.textContent = "Custom API key saved";
    apiStatus.style.color = "#4CAF50";
    sendToWorker({ type: 'save_settings', geminiApiKey: key });
  }
};

useDefaultKey.onclick = () => {
  localStorage.removeItem('geminiApiKey');
  Settings.geminiApiKey = "AIzaSyC9dXJT4ol3i2VoK6aqLjX5S7IMKSjwNC4";
  geminiApiKey.value = "";
  apiStatus.textContent = "Using default API key";
  apiStatus.style.color = "#FFA500";
  sendToWorker({ type: 'save_settings', geminiApiKey: Settings.geminiApiKey });
};

showNotes.onclick = () => {
  if (notesDisplay.style.display === "none") {
    sendToWorker({type:'debug', action:'get_notes'});
    showNotes.textContent = "Hide Notes";
  } else {
    showNotes.textContent = "Show Notes (Debug)";
    notesDisplay.style.display = "none";
  }
};

clearNotes.onclick = () => {
  if (confirm("DANGER: This will permanently delete all notes. Are you sure?")) {
    sendToWorker({type:'debug', action:'clear_notes'});
  }
};

clearChatHistoryBtn.onclick = () => {
  if (confirm("Are you sure you want to clear the chat history?")) {
    clearChatHistory();
  }
};

function sendToWorker(messageObject) {
    SharedWebSocket.send(messageObject);
}

function initializeServiceWorker() {
    // Use shared WebSocket instead of direct service worker communication
    SharedWebSocket.registerHandler('ws_open', () => {
        updateConnectionStatus(true);
    });
    
    SharedWebSocket.registerHandler('ws_close', () => {
        updateConnectionStatus(false);
    });
    
    SharedWebSocket.registerHandler('ws_error', () => {
        updateConnectionStatus(false);
    });
    
    SharedWebSocket.registerHandler('debug_notes', (data) => {
        const notesDisplay = document.getElementById("notesDisplay");
        if (notesDisplay) {
            notesDisplay.textContent = data.notes;
            notesDisplay.style.display = "block";
        }
    });
    
    SharedWebSocket.registerHandler('debug_cleared', (data) => {
        const notesDisplay = document.getElementById("notesDisplay");
        const showNotes = document.getElementById("showNotes");
        if (notesDisplay) notesDisplay.style.display = "none";
        if (showNotes) showNotes.textContent = "Show Notes (Debug)";
    });
    
    SharedWebSocket.registerHandler('auto_confirm_status', (data) => {
        GlobalAutoConfirm.enabled = data.enabled;
        Settings.autoConfirm = data.enabled;
        GlobalAutoConfirm.updateUI();
    });
}

function updateConnectionStatus(connected) {
  const statusLed = document.getElementById('statusLed');
  const statusText = document.getElementById('statusText');
  if (!statusLed || !statusText) return;
  if (connected) {
    statusLed.className = 'connection-led connected';
    statusText.textContent = 'Connected';
  } else {
    statusLed.className = 'connection-led disconnected';
    statusText.textContent = 'Connecting...';
  }
}

function clearChatHistory() {
  localStorage.removeItem('chatHistory');
}

function initializeSettings() {
  const key = localStorage.getItem('geminiApiKey');
  if (key) Settings.geminiApiKey = key;
  loadStoredApiKey();
}

/* ---------- Page Load ---------- */
initializeSettings();
initializeServiceWorker();

</script>
</body>
</html>