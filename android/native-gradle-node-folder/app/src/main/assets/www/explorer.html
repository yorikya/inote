<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Explorer ‚Äì Note Secretary</title>
<link rel="stylesheet" href="common.css">
<link rel="stylesheet" href="explorer.css">
<style>
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #0b0d10; color: #e6e6e6; overflow-x: hidden; }
  .side-menu { position: fixed !important; top: 0 !important; left: -300px !important; width: 300px !important; height: 100vh !important; background: #1e1e1e !important; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5) !important; transition: left 0.3s ease !important; z-index: 1001 !important; overflow-y: auto !important; }
  .side-menu.open { left: 0 !important; }
  .side-menu-header { display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 20px !important; border-bottom: 1px solid #333 !important; }
  .side-menu-header h2 { margin: 0 !important; font-size: 20px !important; color: #fff !important; }
  .side-menu-header button { background: none !important; border: none !important; color: #fff !important; font-size: 24px !important; cursor: pointer !important; padding: 0 !important; width: 30px !important; height: 30px !important; display: flex !important; align-items: center !important; justify-content: center !important; }
  .side-menu-content { padding: 20px !important; }
  .side-menu-content h3 { margin: 0 0 10px 0 !important; font-size: 16px !important; color: #fff !important; }
  .overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.5) !important; z-index: 1000 !important; display: none !important; }
  .overlay.show { display: block !important; }
  .nav-button { width: 100% !important; padding: 12px 16px !important; margin-bottom: 8px !important; background: #2a2f36 !important; color: #e6e6e6 !important; border: 1px solid #444 !important; border-radius: 8px !important; cursor: pointer !important; font-size: 16px !important; text-align: left !important; transition: all 0.2s ease !important; }
  .nav-button:hover { background: #1f6feb !important; border-color: #1f6feb !important; }
  .nav-button.active { background: #1f6feb !important; border-color: #1f6feb !important; }
  .edit-note-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
  .edit-note-image-item { position: relative; width: 100px; height: 100px; }
  .edit-note-image-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
  .edit-note-image-item .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .edit-menu { position: fixed; background: #2a2f36; border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2000; padding: 8px 0; width: max-content; }
  .edit-menu-item { padding: 10px 16px; color: #e6e6e6; cursor: pointer; font-size: 14px; white-space: nowrap; }
  .edit-menu-item:hover { background: #1f6feb; }
  .edit-menu-item.danger:hover { background: #d93025; }
</style>
</head>
<body>
<div class="app">
  <header>
    <button id="menuBtn">‚ò∞</button>
    <h1>üìù Note Explorer</h1>
    <div class="spacer"></div>
    <button id="refreshBtn">üîÑ Refresh</button>
  </header>
  <div class="search-container">
    <input type="text" id="searchInput" class="search-bar" placeholder="Search notes...">
  </div>
  <div class="notes-container">
    <div id="loadingState" class="loading" style="display:none;">Loading notes...</div>
    <div id="emptyState" class="empty-state" style="display:none;"><h3>No notes found</h3><p>Create one in the Chat interface</p></div>
    <div id="notesGrid" class="notes-grid"></div>
  </div>
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">‚úèÔ∏è Edit Note</h3><button class="modal-close" onclick="closeEditModal()">&times;</button></div>
      <div class="modal-body">
        <div><label>Note ID</label><input type="text" id="editNoteId" readonly disabled></div>
        <div><label>Title *</label><input type="text" id="editNoteTitle" placeholder="Enter note title" required></div>
        <div><label>Description</label><textarea id="editNoteDescription" rows="6" placeholder="Enter note description"></textarea></div>
        <div><label>Images</label><div id="editNoteImages" class="edit-note-images"></div></div>
        <div><label style="display: flex; align-items: center;"><input type="checkbox" id="editNoteDone"><span>Mark as completed</span></label></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;"><button onclick="closeEditModal()">‚ùå Cancel</button><button onclick="saveNoteChanges()">üíæ Save</button></div>
      </div>
    </div>
  </div>
</div>
<div class="overlay" id="overlay"></div>
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header"><h2>Menu</h2><button id="closeMenu">‚úï</button></div>
  <div class="side-menu-content">
    <h3>Navigation</h3>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">
      <button id="chatButton" class="nav-button secondary">üí¨ Chat</button>
      <button id="explorerButton" class="nav-button active">üìù Note Explorer</button>
      <button id="settingsButton" class="nav-button secondary">‚öôÔ∏è Settings</button>
    </div>
    <h3>Filter Options</h3>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">
      <button id="showAllBtn" class="nav-button">üìã All Notes</button>
      <button id="showCompletedBtn" class="nav-button secondary">‚úÖ Completed</button>
      <button id="showPendingBtn" class="nav-button secondary">‚è≥ Pending</button>
    </div>
  </div>
</div>

<!-- Load shared WebSocket client -->
<script src="shared-websocket.js"></script>

<script>
const menuBtn = document.getElementById("menuBtn");
const sideMenu = document.getElementById("sideMenu");
const overlay = document.getElementById("overlay");
const closeMenu = document.getElementById("closeMenu");
const searchInput = document.getElementById("searchInput");
const refreshBtn = document.getElementById("refreshBtn");
const notesGrid = document.getElementById("notesGrid");
const loadingState = document.getElementById("loadingState");
const emptyState = document.getElementById("emptyState");
const chatButton = document.getElementById("chatButton");
const explorerButton = document.getElementById("explorerButton");
const settingsButton = document.getElementById("settingsButton");
const showAllBtn = document.getElementById("showAllBtn");
const showCompletedBtn = document.getElementById("showCompletedBtn");
const showPendingBtn = document.getElementById("showPendingBtn");
const editModal = document.getElementById("editModal");
const editNoteImages = document.getElementById("editNoteImages");

let allNotes = [], filteredNotes = [], currentFilter = 'all', noteImageStates = {}, imageRotationIntervals = {};

function sendToWorker(msg) {
    SharedWebSocket.send(msg);
}

function showEditMenu(noteId, event) {
  event.stopPropagation();
  event.preventDefault();
  document.querySelectorAll('.edit-menu').forEach(menu => menu.remove());
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  const menu = document.createElement('div');
  menu.className = 'edit-menu';
  const items = [
    { text: '‚úèÔ∏è Edit Note', action: () => openEditModal(noteId) },
    { text: 'üí¨ Open In Chat', action: () => window.location.href = `index.html?findbyid=${noteId}` },
    { text: note.done ? '‚è≥ Mark as Pending' : '‚úÖ Mark as Done', action: () => toggleNoteDone(noteId) },
    { text: 'üóëÔ∏è Delete Note', action: () => deleteNote(noteId), danger: true }
  ];
  items.forEach(item => {
    const menuItem = document.createElement('div');
    menuItem.className = 'edit-menu-item';
    if (item.danger) menuItem.classList.add('danger');
    menuItem.innerHTML = item.text;
    menuItem.onclick = (e) => { e.stopPropagation(); item.action(); menu.remove(); };
    menu.appendChild(menuItem);
  });
  menu.style.position = 'fixed';
  menu.style.top = `${event.clientY}px`;
  menu.style.left = `${event.clientX}px`;
  document.body.appendChild(menu);
  setTimeout(() => {
    document.addEventListener('click', function closeMenuHandler(e) {
      if (!menu.contains(e.target)) menu.remove();
    }, { once: true });
  }, 0);
}

window.rotateImage = function(noteId, dir) {
  const note = allNotes.find(n => n.id === noteId);
  if (!note || !note.images || note.images.length <= 1) return;
  if (!noteImageStates[noteId]) noteImageStates[noteId] = { currentIndex: 0, totalImages: note.images.length };
  const state = noteImageStates[noteId];
  state.currentIndex = (state.currentIndex + dir + state.totalImages) % state.totalImages;
  updateNoteImage(noteId, note.images[state.currentIndex], state.currentIndex);
};

function updateNoteImage(noteId, imagePath, idx) {
  const imgEl = document.getElementById(`note-img-${noteId}`);
  const counterEl = document.querySelector(`[data-note-id="${noteId}"] .image-counter`);
  if (imgEl) imgEl.src = convertImagePathForDisplay(imagePath);
  if (counterEl) {
    const note = allNotes.find(n => n.id === noteId);
    if (note && note.images) counterEl.textContent = `${idx + 1} / ${note.images.length}`;
  }
}

function openEditModal(noteId) {
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return alert('Note not found.');
  document.getElementById('editNoteId').value = note.id;
  document.getElementById('editNoteTitle').value = note.title || '';
  document.getElementById('editNoteDescription').value = note.description || '';
  document.getElementById('editNoteDone').checked = note.done;
  editNoteImages.innerHTML = '';
  if (note.images) {
    note.images.forEach(path => {
      const c = document.createElement('div'); c.className = 'edit-note-image-item';
      const i = document.createElement('img'); i.src = convertImagePathForDisplay(path);
      const d = document.createElement('button'); d.className = 'delete-btn'; d.innerHTML = '&times;';
      d.onclick = () => deleteNoteImage(note.id, path, c);
      c.appendChild(i); c.appendChild(d); editNoteImages.appendChild(c);
    });
  }
  editModal.classList.add('show');
}

function closeEditModal() { editModal.classList.remove('show'); }

function saveNoteChanges() {
  const noteId = document.getElementById('editNoteId').value;
  const title = document.getElementById('editNoteTitle').value.trim();
  if (!title) return alert('Title is required');
  sendToWorker({
    type: 'update_note',
    noteId: noteId,
    updates: { title, description: document.getElementById('editNoteDescription').value.trim(), done: document.getElementById('editNoteDone').checked }
  });
  closeEditModal();
  showToast('üíæ Saving...');
}

function deleteNoteImage(noteId, path, el) {
  if (!confirm('Are you sure you want to delete this image?')) return;
  sendToWorker({ type: 'chat', text: `/findbyid ${noteId}` });
  setTimeout(() => {
    sendToWorker({ type: 'chat', text: `/deleteimage ${path}` });
    if (el) el.remove();
    const note = allNotes.find(n => String(n.id) === String(noteId));
    if (note && note.images) note.images = note.images.filter(p => p !== path);
  }, 100);
}

function toggleNoteDone(noteId) {
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  sendToWorker({ type: 'update_note', noteId: String(noteId), updates: { done: !note.done } });
}

function deleteNote(noteId) {
  if (!confirm('Are you sure you want to delete this note?')) return;
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  sendToWorker({ type: 'chat', text: `/findbyid ${noteId}` });
  setTimeout(() => { sendToWorker({ type: 'chat', text: '/delete' }); }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
  initializeServiceWorker();
  setupEventListeners();
});

function initializeServiceWorker() {
    // Use shared WebSocket instead of direct service worker communication
    SharedWebSocket.registerHandler('ws_open', () => {
        loadNotes();
    });
    
    SharedWebSocket.registerHandler('all_notes', (data) => {
        allNotes = data.notes || [];
        applyCurrentFilter();
        renderNotes();
    });
    
    SharedWebSocket.registerHandler('note_updated', (data) => {
        loadNotes();
    });
    
    SharedWebSocket.registerHandler('note_created', (data) => {
        loadNotes();
    });
    
    SharedWebSocket.registerHandler('note_deleted', (data) => {
        loadNotes();
    });
    
    SharedWebSocket.registerHandler('cleanup_complete', (data) => {
        loadNotes();
    });
}

// handleWebSocketMessage function removed - now using SharedWebSocket handlers

function setupEventListeners() {
  menuBtn.onclick = () => { sideMenu.classList.add("open"); overlay.classList.add("show"); };
  closeMenu.onclick = () => { sideMenu.classList.remove("open"); overlay.classList.remove("show"); };
  overlay.onclick = () => { sideMenu.classList.remove("open"); overlay.classList.remove("show"); };
  chatButton.onclick = () => window.location.href = 'index.html';
  explorerButton.onclick = () => { sideMenu.classList.remove("open"); overlay.classList.remove("show"); };
  settingsButton.onclick = () => window.location.href = 'settings.html';
  searchInput.addEventListener('input', () => { applyCurrentFilter(); renderNotes(); });
  refreshBtn.onclick = () => loadNotes();
  showAllBtn.onclick = () => setFilter('all');
  showCompletedBtn.onclick = () => setFilter('completed');
  showPendingBtn.onclick = () => setFilter('pending');
  notesGrid.addEventListener('click', function(e) {
    const noteCard = e.target.closest('.note-card');
    if (noteCard && !e.target.closest('button, a, input, .edit-menu')) {
        const noteId = noteCard.getAttribute('data-note-id');
        if (noteId) showEditMenu(noteId, e);
    }
  });
}

function setFilter(filter) {
  currentFilter = filter;
  [showAllBtn, showCompletedBtn, showPendingBtn].forEach(b => b.classList.remove('active'));
  if (filter === 'all') showAllBtn.classList.add('active');
  else if (filter === 'completed') showCompletedBtn.classList.add('active');
  else showPendingBtn.classList.add('active');
  applyCurrentFilter();
  renderNotes();
}

function applyCurrentFilter() {
  const term = searchInput.value.toLowerCase();
  filteredNotes = allNotes.filter(n => {
    const searchMatch = !term || n.title.toLowerCase().includes(term) || (n.description && n.description.toLowerCase().includes(term));
    const statusMatch = currentFilter === 'all' || (currentFilter === 'completed' && n.done) || (currentFilter === 'pending' && !n.done);
    return searchMatch && statusMatch && !n.deleted;
  });
}

function loadNotes() {
  loadingState.style.display = 'block';
  emptyState.style.display = 'none';
  notesGrid.style.display = 'none';
  sendToWorker({ type: "get_all_notes" });
}

function renderNotes() {
  loadingState.style.display = 'none';
  if (filteredNotes.length === 0) {
    emptyState.style.display = 'block';
    notesGrid.style.display = 'none';
    return;
  }
  emptyState.style.display = 'none';
  notesGrid.style.display = 'grid';
  const sorted = [...filteredNotes].sort((a, b) => (new Date(b.creation_date || 0)) - (new Date(a.creation_date || 0)));
  notesGrid.innerHTML = sorted.map(createNoteCard).join('');
}

function createNoteCard(note) {
  const statusClass = note.done ? 'completed' : 'pending';
  const imageCount = note.images ? note.images.length : 0;
  let imageHtml = '';
  if (imageCount > 0) {
    const path = convertImagePathForDisplay(note.images[0]);
    if (path) {
        imageHtml = `<div class="note-images" data-note-id="${note.id}"><div class="image-preview-container"><img class="image-preview-img" src="${path}" alt="Note image"></div></div>`;
    }
  }
  return `
    <div class="note-card ${statusClass}" data-note-id="${note.id}">
      <div class="note-header"><div class="note-title">${escapeHtml(note.title)}</div></div>
      ${note.description ? `<div class="note-description">${escapeHtml(note.description)}</div>` : ''}
      ${imageHtml}
      <div class="note-meta"><span class="note-id">#${note.id}</span><span class="note-status ${statusClass}">${note.done ? 'Completed' : 'Pending'}</span></div>
    </div>
  `;
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text || '';
  return d.innerHTML;
}

function convertImagePathForDisplay(path) {
  if (!path || path.startsWith('http') || path.startsWith('content://')) return path;
  return `http://127.0.0.1:30000/image/${path}`;
}

function showToast(message) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = message;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>