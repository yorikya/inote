<!-- Explorer Page Content -->
<div class="search-container">
  <input type="text" id="searchInput" class="search-bar" placeholder="Search notes...">
</div>
<div class="notes-container">
  <div id="loadingState" class="loading" style="display:none;">Loading notes...</div>
  <div id="emptyState" class="empty-state" style="display:none;"><h3>No notes found</h3><p>Create one in the Chat interface</p></div>
  <div id="notesGrid" class="notes-grid"></div>
</div>
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3 class="modal-title">‚úèÔ∏è Edit Note</h3><button class="modal-close" onclick="closeEditModal()">&times;</button></div>
    <div class="modal-body">
      <div><label>Note ID</label><input type="text" id="editNoteId" readonly disabled></div>
      <div><label>Title *</label><input type="text" id="editNoteTitle" placeholder="Enter note title" required></div>
      <div><label>Description</label><textarea id="editNoteDescription" rows="6" placeholder="Enter note description"></textarea></div>
      <div><label>Images</label><div id="editNoteImages" class="edit-note-images"></div></div>
      <div><label style="display: flex; align-items: center;"><input type="checkbox" id="editNoteDone"><span>Mark as completed</span></label></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;"><button onclick="closeEditModal()">‚ùå Cancel</button><button onclick="saveNoteChanges()">üíæ Save</button></div>
    </div>
  </div>
</div>

<script>
console.log('Explorer page script starting...');
console.log('About to define function...');

// Simple test function first
function testExplorerFunction() {
  console.log('Test function called');
}

// Make it globally accessible
window.testExplorerFunction = testExplorerFunction;
console.log('Test function registered globally');

// Explorer page specific functionality
let allNotes = [], filteredNotes = [], currentFilter = 'all', noteImageStates = {}, imageRotationIntervals = {};
console.log('Variables initialized');

// Initialize explorer page when loaded
function initializeExplorerPageWhenReady() {
  // Wait for the main app to be ready and DOM elements to be available
  if (window.App && window.SharedWebSocket && document.getElementById("searchInput")) {
    initializeExplorerPage();
  } else {
    setTimeout(initializeExplorerPageWhenReady, 100);
  }
}

// Make function globally accessible
console.log('About to register function globally...');
window.initializeExplorerPageWhenReady = initializeExplorerPageWhenReady;
console.log('initializeExplorerPageWhenReady function registered globally');
console.log('Function type:', typeof window.initializeExplorerPageWhenReady);

function initializeExplorerPage() {
  console.log('Initializing explorer page...');
  
  // Setup UI elements
  const searchInput = document.getElementById("searchInput");
  const notesGrid = document.getElementById("notesGrid");
  const loadingState = document.getElementById("loadingState");
  const emptyState = document.getElementById("emptyState");
  const editModal = document.getElementById("editModal");
  const editNoteImages = document.getElementById("editNoteImages");

  console.log('Found elements:', { searchInput, notesGrid, loadingState, emptyState });

  // Setup event listeners
  if (searchInput) {
    searchInput.addEventListener('input', () => { applyCurrentFilter(); renderNotes(); });
    console.log('Search input listener added');
  }

  // Filter buttons are now in the main app side menu
  const showAllBtn = document.getElementById("showAllBtn");
  const showCompletedBtn = document.getElementById("showCompletedBtn");
  const showPendingBtn = document.getElementById("showPendingBtn");
  
  if (showAllBtn) {
    showAllBtn.onclick = () => setFilter('all');
    console.log('All button listener added');
  }
  if (showCompletedBtn) {
    showCompletedBtn.onclick = () => setFilter('completed');
    console.log('Completed button listener added');
  }
  if (showPendingBtn) {
    showPendingBtn.onclick = () => setFilter('pending');
    console.log('Pending button listener added');
  }

  if (notesGrid) {
    notesGrid.addEventListener('click', function(e) {
      const noteCard = e.target.closest('.note-card');
      if (noteCard && !e.target.closest('button, a, input, .edit-menu')) {
        const noteId = noteCard.getAttribute('data-note-id');
        if (noteId) showEditMenu(noteId, e);
      }
    });
    console.log('Notes grid click listener added');
  }

  // Register WebSocket handlers
  registerExplorerWebSocketHandlers();
  
  // Load notes
  console.log('Loading notes...');
  loadNotes();
}

function sendToWorker(msg) {
  console.log('sendToWorker called with:', msg);
  console.log('SharedUtils available:', !!window.SharedUtils);
  console.log('SharedUtils.sendToWorker available:', !!(window.SharedUtils && window.SharedUtils.sendToWorker));
  if (window.SharedUtils && window.SharedUtils.sendToWorker) {
    window.SharedUtils.sendToWorker(msg);
  } else {
    console.error('SharedUtils.sendToWorker not available');
  }
}

function showEditMenu(noteId, event) {
  event.stopPropagation();
  event.preventDefault();
  document.querySelectorAll('.edit-menu').forEach(menu => menu.remove());
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  const menu = document.createElement('div');
  menu.className = 'edit-menu';
  const items = [
    { text: '‚úèÔ∏è Edit Note', action: () => openEditModal(noteId) },
    { text: 'üí¨ Open In Chat', action: () => openNoteInChat(noteId) },
    { text: note.done ? '‚è≥ Mark as Pending' : '‚úÖ Mark as Done', action: () => toggleNoteDone(noteId) },
    { text: 'üóëÔ∏è Delete Note', action: () => deleteNote(noteId), danger: true }
  ];
  items.forEach(item => {
    const menuItem = document.createElement('div');
    menuItem.className = 'edit-menu-item';
    if (item.danger) menuItem.classList.add('danger');
    menuItem.innerHTML = item.text;
    menuItem.onclick = (e) => { e.stopPropagation(); item.action(); menu.remove(); };
    menu.appendChild(menuItem);
  });
  // Position the menu with consistent width and smart positioning
  menu.style.position = 'fixed';
  menu.style.top = `${event.clientY}px`;
  menu.style.left = `${event.clientX}px`;
  document.body.appendChild(menu);
  
  // Adjust position if menu goes off-screen
  const menuRect = menu.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // Adjust horizontal position if menu goes off the right edge
  if (menuRect.right > viewportWidth) {
    menu.style.left = `${viewportWidth - menuRect.width - 10}px`;
  }
  
  // Adjust vertical position if menu goes off the bottom edge
  if (menuRect.bottom > viewportHeight) {
    menu.style.top = `${event.clientY - menuRect.height}px`;
  }
  
  // Ensure menu doesn't go off the left edge
  if (menuRect.left < 10) {
    menu.style.left = '10px';
  }
  
  // Ensure menu doesn't go off the top edge
  if (menuRect.top < 10) {
    menu.style.top = '10px';
  }
  setTimeout(() => {
    document.addEventListener('click', function closeMenuHandler(e) {
      if (!menu.contains(e.target)) menu.remove();
    }, { once: true });
  }, 0);
}

window.rotateImage = function(noteId, dir) {
  const note = allNotes.find(n => n.id === noteId);
  if (!note || !note.images || note.images.length <= 1) return;
  if (!noteImageStates[noteId]) noteImageStates[noteId] = { currentIndex: 0, totalImages: note.images.length };
  const state = noteImageStates[noteId];
  state.currentIndex = (state.currentIndex + dir + state.totalImages) % state.totalImages;
  updateNoteImage(noteId, note.images[state.currentIndex], state.currentIndex);
};

function updateNoteImage(noteId, imagePath, idx) {
  const imgEl = document.getElementById(`note-img-${noteId}`);
  const counterEl = document.querySelector(`[data-note-id="${noteId}"] .image-counter`);
  if (imgEl) imgEl.src = convertImagePathForDisplay(imagePath);
  if (counterEl) {
    const note = allNotes.find(n => n.id === noteId);
    if (note && note.images) counterEl.textContent = `${idx + 1} / ${note.images.length}`;
  }
}

function openEditModal(noteId) {
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return alert('Note not found.');
  document.getElementById('editNoteId').value = note.id;
  document.getElementById('editNoteTitle').value = note.title || '';
  document.getElementById('editNoteDescription').value = note.description || '';
  document.getElementById('editNoteDone').checked = note.done;
  const editNoteImages = document.getElementById('editNoteImages');
  if (editNoteImages) {
    editNoteImages.innerHTML = '';
    if (note.images) {
      note.images.forEach(path => {
        const c = document.createElement('div'); c.className = 'edit-note-image-item';
        const i = document.createElement('img'); i.src = convertImagePathForDisplay(path);
        const d = document.createElement('button'); d.className = 'delete-btn'; d.innerHTML = '&times;';
        d.onclick = () => deleteNoteImage(note.id, path, c);
        c.appendChild(i); c.appendChild(d); editNoteImages.appendChild(c);
      });
    }
  }
  const editModal = document.getElementById('editModal');
  if (editModal) editModal.classList.add('show');
}

function closeEditModal() {
  const editModal = document.getElementById('editModal');
  if (editModal) editModal.classList.remove('show');
}

function saveNoteChanges() {
  const noteId = document.getElementById('editNoteId').value;
  const title = document.getElementById('editNoteTitle').value.trim();
  if (!title) return alert('Title is required');
  sendToWorker({
    type: 'update_note',
    noteId: noteId,
    updates: { title, description: document.getElementById('editNoteDescription').value.trim(), done: document.getElementById('editNoteDone').checked }
  });
  closeEditModal();
  showToast('üíæ Saving...');
}

function deleteNoteImage(noteId, path, el) {
  if (!confirm('Are you sure you want to delete this image?')) return;
  sendToWorker({ type: 'chat', text: `/findbyid ${noteId}` });
  setTimeout(() => {
    sendToWorker({ type: 'chat', text: `/deleteimage ${path}` });
    if (el) el.remove();
    const note = allNotes.find(n => String(n.id) === String(noteId));
    if (note && note.images) note.images = note.images.filter(p => p !== path);
  }, 100);
}

function toggleNoteDone(noteId) {
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  sendToWorker({ type: 'update_note', noteId: String(noteId), updates: { done: !note.done } });
}

function deleteNote(noteId) {
  if (!confirm('Are you sure you want to delete this note?')) return;
  const note = allNotes.find(n => String(n.id) === String(noteId));
  if (!note) return;
  sendToWorker({ type: 'chat', text: `/findbyid ${noteId}` });
  setTimeout(() => { sendToWorker({ type: 'chat', text: '/delete' }); }, 100);
}

function setFilter(filter) {
  currentFilter = filter;
  const showAllBtn = document.getElementById("showAllBtn");
  const showCompletedBtn = document.getElementById("showCompletedBtn");
  const showPendingBtn = document.getElementById("showPendingBtn");
  
  [showAllBtn, showCompletedBtn, showPendingBtn].forEach(b => {
    if (b) b.classList.remove('active');
  });
  
  if (filter === 'all' && showAllBtn) showAllBtn.classList.add('active');
  else if (filter === 'completed' && showCompletedBtn) showCompletedBtn.classList.add('active');
  else if (showPendingBtn) showPendingBtn.classList.add('active');
  
  applyCurrentFilter();
  renderNotes();
}

// Make setFilter globally accessible
window.setFilter = setFilter;

function applyCurrentFilter() {
  console.log('applyCurrentFilter called with allNotes:', allNotes.length, 'currentFilter:', currentFilter);
  const searchInput = document.getElementById("searchInput");
  const term = searchInput ? searchInput.value.toLowerCase() : '';
  console.log('Search term:', term);
  
  filteredNotes = allNotes.filter(n => {
    const searchMatch = !term || n.title.toLowerCase().includes(term) || (n.description && n.description.toLowerCase().includes(term));
    const statusMatch = currentFilter === 'all' || (currentFilter === 'completed' && n.done) || (currentFilter === 'pending' && !n.done);
    return searchMatch && statusMatch && !n.deleted;
  });
  
  console.log('Filtered notes:', filteredNotes.length);
}

function loadNotes() {
  console.log('loadNotes called');
  const loadingState = document.getElementById("loadingState");
  const emptyState = document.getElementById("emptyState");
  const notesGrid = document.getElementById("notesGrid");
  
  console.log('Elements found:', { loadingState, emptyState, notesGrid });
  
  if (loadingState) {
    loadingState.style.display = 'block';
    console.log('Loading state shown');
  }
  if (emptyState) emptyState.style.display = 'none';
  if (notesGrid) notesGrid.style.display = 'none';
  
  console.log('Sending get_all_notes request...');
  sendToWorker({ type: "get_all_notes" });
}

function renderNotes() {
  console.log('renderNotes called with filteredNotes:', filteredNotes.length);
  const loadingState = document.getElementById("loadingState");
  const emptyState = document.getElementById("emptyState");
  const notesGrid = document.getElementById("notesGrid");
  
  console.log('Elements found:', { loadingState, emptyState, notesGrid });
  
  if (loadingState) loadingState.style.display = 'none';
  
  if (filteredNotes.length === 0) {
    console.log('No filtered notes, showing empty state');
    if (emptyState) emptyState.style.display = 'block';
    if (notesGrid) notesGrid.style.display = 'none';
    return;
  }
  
  console.log('Rendering notes...');
  if (emptyState) emptyState.style.display = 'none';
  if (notesGrid) {
    notesGrid.style.display = 'grid';
    const sorted = [...filteredNotes].sort((a, b) => (new Date(b.creation_date || 0)) - (new Date(a.creation_date || 0)));
    console.log('Sorted notes:', sorted);
    notesGrid.innerHTML = sorted.map(createNoteCard).join('');
    console.log('Notes rendered to grid');
  }
}

function createNoteCard(note) {
  const statusClass = note.done ? 'completed' : 'pending';
  const imageCount = note.images ? note.images.length : 0;
  let imageHtml = '';
  if (imageCount > 0) {
    const path = convertImagePathForDisplay(note.images[0]);
    if (path) {
        imageHtml = `<div class="note-images" data-note-id="${note.id}"><div class="image-preview-container"><img class="image-preview-img" src="${path}" alt="Note image"></div></div>`;
    }
  }
  return `
    <div class="note-card ${statusClass}" data-note-id="${note.id}">
      <div class="note-header"><div class="note-title">${escapeHtml(note.title)}</div></div>
      ${note.description ? `<div class="note-description">${escapeHtml(note.description)}</div>` : ''}
      ${imageHtml}
      <div class="note-meta">
        <span class="note-id">#${note.id}</span>
        <span class="note-status ${statusClass}">${note.done ? 'Completed' : 'Pending'}</span>
      </div>
    </div>
  `;
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text || '';
  return d.innerHTML;
}

function convertImagePathForDisplay(path) {
  console.log('convertImagePathForDisplay called with:', path);
  console.log('SharedUtils available:', !!window.SharedUtils);
  console.log('SharedUtils.convertImagePathForDisplay available:', !!(window.SharedUtils && window.SharedUtils.convertImagePathForDisplay));
  if (window.SharedUtils && window.SharedUtils.convertImagePathForDisplay) {
    return window.SharedUtils.convertImagePathForDisplay(path);
  } else {
    console.error('SharedUtils.convertImagePathForDisplay not available');
    return path; // fallback
  }
}

function showToast(message) {
  SharedUtils.showToast(message);
}

function openNoteInChat(noteId) {
  console.log('Opening note in chat:', noteId);
  // Store the note ID for the chat page
  localStorage.setItem('currentNoteId', noteId);
  // Navigate to chat page
  if (window.navigateTo) {
    window.navigateTo('chat');
  } else {
    console.error('navigateTo not available for navigation');
  }
}

// Register WebSocket handlers for explorer page
function registerExplorerWebSocketHandlers() {
  if (window.SharedWebSocket) {
    console.log('Registering WebSocket handlers for explorer page');
    
    SharedWebSocket.registerHandler('all_notes', (data) => {
      console.log('Received all_notes:', data);
      allNotes = data.notes || [];
      console.log('All notes set:', allNotes);
      applyCurrentFilter();
      renderNotes();
    });
    
    SharedWebSocket.registerHandler('note_updated', (data) => {
      console.log('Note updated, reloading...');
      loadNotes();
    });
    
    SharedWebSocket.registerHandler('note_created', (data) => {
      console.log('Note created, reloading...');
      loadNotes();
    });
    
    SharedWebSocket.registerHandler('note_deleted', (data) => {
      console.log('Note deleted, reloading...');
      loadNotes();
    });
    
    SharedWebSocket.registerHandler('cleanup_complete', (data) => {
      console.log('Cleanup complete, reloading...');
      loadNotes();
    });
  } else {
    console.log('SharedWebSocket not available');
  }
}

// Register handlers when the page is ready
if (window.SharedWebSocket) {
  registerExplorerWebSocketHandlers();
} else {
  // Wait for SharedWebSocket to be available
  const checkWebSocket = setInterval(() => {
    if (window.SharedWebSocket) {
      clearInterval(checkWebSocket);
      registerExplorerWebSocketHandlers();
    }
  }, 100);
}

console.log('Explorer page script completed');
</script>
